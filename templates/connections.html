<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grafo de Influência - Top 30 Áreas Críticas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="//unpkg.com/force-graph"></script>
    <style>
        body { margin: 0; background-color: #121212; color: #e0e0e0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #graph { width: 100vw; height: 100vh; }
        .overlay-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            pointer-events: none; /* Allow click through */
        }
        .interactive {
            pointer-events: auto;
        }
        .card-glass {
            background: rgba(30, 30, 30, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            color: #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            max-width: 350px;
        }
        .btn-glass {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s;
        }
        .btn-glass:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-color: rgba(255,255,255,0.4);
        }
        .node-label {
            font-size: 12px;
            background: rgba(0,0,0,0.6);
            padding: 2px 4px;
            border-radius: 4px;
        }
        #node-details {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: none;
        }
    </style>
</head>
<body>

    <div class="overlay-ui">
        <div class="interactive mb-3">
            <a href="/" class="btn btn-glass btn-sm"><i class="fas fa-arrow-left"></i> Voltar ao Dashboard</a>
        </div>
        <div class="card-glass interactive">
            <h5 class="mb-2"><i class="fas fa-project-diagram"></i> Rede de Influência</h5>
            <p class="small text-muted mb-2">Top 30 Áreas Críticas</p>
            <div class="small">
                <span class="d-inline-block me-2"><i class="fas fa-circle" style="color: #ff4444;"></i> Risco Alto</span>
                <span class="d-inline-block"><i class="fas fa-circle" style="color: #00bcd4;"></i> Conexões</span>
            </div>
            <div class="mt-2 text-muted" style="font-size: 0.8rem;">
                Setas indicam o fluxo de influência espacial e logística entre as áreas, conforme modelado pela matriz de adjacência.
            </div>
        </div>
    </div>

    <div id="node-details" class="card-glass interactive">
        <h5 id="d-name">Nome da Área</h5>
        <div class="mb-2">
            <span class="badge bg-secondary" id="d-faction">Facção</span>
            <span class="badge bg-danger" id="d-risk">Risco: 0%</span>
        </div>
        <hr class="border-secondary my-2">
        <h6 class="small text-muted">Motivos:</h6>
        <ul id="d-reasons" class="small ps-3 mb-0"></ul>
    </div>

    <div id="graph"></div>

    <script>
        const elem = document.getElementById('graph');

        function getColor(score) {
            // Gradient from Green to Red based on score 0-100?
            // Top 30 are likely all high.
            // Let's use Faction colors if available, or Risk.
            if (score >= 80) return '#ff4444'; // Red
            if (score >= 60) return '#ffbb33'; // Orange
            return '#00C851'; // Green
        }

        // Faction color mapping (deterministic)
        const factionColors = {};
        const colors = ['#FF8800', '#9933CC', '#0099CC', '#CC0000', '#007E33', '#33b5e5'];
        let colorIdx = 0;

        function getFactionColor(faction) {
            if (!faction || faction === 'N/A' || faction === 'None') return '#757575'; // Grey
            if (!factionColors[faction]) {
                factionColors[faction] = colors[colorIdx % colors.length];
                colorIdx++;
            }
            return factionColors[faction];
        }

        fetch('/api/network-graph')
            .then(res => res.json())
            .then(data => {
                const Graph = ForceGraph()(elem)
                    .graphData(data)
                    .backgroundColor('#121212')
                    .nodeLabel('name')
                    .nodeColor(node => getFactionColor(node.faction))
                    .nodeRelSize(6)
                    .linkDirectionalArrowLength(3.5)
                    .linkDirectionalArrowRelPos(1)
                    .linkDirectionalParticles(2)
                    .linkDirectionalParticleSpeed(d => d.weight * 0.005) // Faster if stronger weight?
                    .linkWidth(d => Math.max(1, d.weight * 2)) // Width by weight
                    .onNodeClick(node => {
                        // Zoom to node
                        Graph.centerAt(node.x, node.y, 1000);
                        Graph.zoom(8, 2000);

                        // Show Details
                        document.getElementById('d-name').textContent = node.name;
                        document.getElementById('d-faction').textContent = node.faction || 'Não Identificado';
                        document.getElementById('d-faction').style.backgroundColor = getFactionColor(node.faction);
                        document.getElementById('d-risk').textContent = 'Risco: ' + node.risk.toFixed(1) + '%';

                        const list = document.getElementById('d-reasons');
                        list.innerHTML = '';
                        if(node.reasons && node.reasons.length) {
                            node.reasons.forEach(r => {
                                const li = document.createElement('li');
                                li.textContent = r;
                                list.appendChild(li);
                            });
                        } else {
                            list.innerHTML = '<li>Sem motivos específicos identificados.</li>';
                        }

                        document.getElementById('node-details').style.display = 'block';
                    })
                    .onBackgroundClick(() => {
                        document.getElementById('node-details').style.display = 'none';
                    });

                // Add nice gravity
                Graph.d3Force('charge').strength(-120);

                // Add ring for Risk Level
                Graph.nodeCanvasObject((node, ctx, globalScale) => {
                    const label = node.name;
                    const fontSize = 12/globalScale;

                    // Draw node
                    const r = 4;
                    ctx.beginPath();
                    ctx.arc(node.x, node.y, r, 0, 2 * Math.PI, false);
                    ctx.fillStyle = getFactionColor(node.faction);
                    ctx.fill();

                    // Ring for risk
                    ctx.beginPath();
                    ctx.arc(node.x, node.y, r + 1, 0, 2 * Math.PI, false);
                    ctx.strokeStyle = getColor(node.risk);
                    ctx.lineWidth = 0.5;
                    ctx.stroke();

                    // Text
                    ctx.font = `${fontSize}px Sans-Serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.fillText(label, node.x, node.y + r + fontSize);
                });
            })
            .catch(err => console.error(err));
    </script>
</body>
</html>
