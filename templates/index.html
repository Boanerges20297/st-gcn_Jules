<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento de Inteligência - Segurança Pública</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { padding-top: 20px; background-color: #f8f9fa; }
        #map { min-height: 600px; width: 100%; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .metric-card { transition: transform 0.2s; }
        .metric-card:hover { transform: translateY(-5px); }
        .legend { background: white; padding: 10px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7; }
        .simulation-active { cursor: crosshair !important; }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.4);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
            transition: opacity 0.3s ease;
        }
        .loading-content {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        @keyframes pulse-text {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        .loading-text {
            animation: pulse-text 1.5s infinite;
        }
        .loading-icon {
            font-size: 3rem;
            color: #0d6efd;
            animation: spin-radar 2s linear infinite;
        }
        @keyframes spin-radar {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .d-none { display: none !important; }
    </style>
</head>
<body>
<!-- Loading Overlay -->
<div id="loading-overlay">
    <div class="loading-content">
        <div class="mb-3">
             <i class="fas fa-crosshairs loading-icon"></i>
        </div>
        <h4 class="mt-3 text-muted loading-text" id="loading-message">Processando Inteligência Tática...</h4>
        <small class="text-muted" id="loading-sub">Aguarde, analisando dados em tempo real.</small>
    </div>
</div>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="display-6 fw-bold text-primary"><i class="fas fa-shield-alt"></i> Dashboard de Inteligência Preditiva</h1>
            <p class="lead text-muted">Análise de Risco em Áreas Monitoradas (CVLI & CVP)</p>
        </div>
    </div>
    <div class="row mb-4 justify-content-center">
        <div class="col-md-3">
            <div class="card metric-card border-danger mb-3">
                <div class="card-body text-center">
                    <h5 class="card-title text-danger">Áreas de Alto Risco</h5>
                    <p class="card-text display-4 fw-bold" id="high-risk-count">-</p>
                    <small class="text-muted">Previsão para Amanhã</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card border-warning mb-3">
                <div class="card-body text-center">
                    <h5 class="card-title text-warning">Áreas em Alerta</h5>
                    <p class="card-text display-4 fw-bold" id="medium-risk-count">-</p>
                    <small class="text-muted">Atenção Necessária</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card border-success mb-3">
                <div class="card-body text-center">
                    <h5 class="card-title text-success">Áreas Estáveis</h5>
                    <p class="card-text display-4 fw-bold" id="low-risk-count">-</p>
                    <small class="text-muted">Monitoramento Padrão</small>
                </div>
            </div>
        </div>
    </div>
    <div class="row align-items-stretch">
        <div class="col-md-9 d-flex flex-column">
            <div class="card shadow-sm h-100 w-100">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-map-marked-alt"></i> Mapa Tático Operacional</span>
                    <span class="badge bg-danger">Dados Atualizados: Hoje</span>
                </div>
                <div class="card-body p-0 d-flex flex-column">
                    <div id="map" class="flex-grow-1"></div>
                </div>
            </div>
        </div>
        <div class="col-md-3 d-flex flex-column">
            <div class="card shadow-sm h-100 w-100">
                <div class="card-header">
                    <strong>Motivos de Risco</strong>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="mode-switch" checked>
                        <label class="form-check-label" for="mode-switch" id="mode-label">Modo de Visualização: <strong>CVLI</strong></label>
                    </div>
                    <div id="window-info" class="mb-2">
                        <small class="text-muted d-block">Janela Histórica: —</small>
                        <small class="text-primary fw-bold" id="horizon-info">Horizonte: —</small>
                    </div>

                    <div class="d-grid gap-2 mb-2">
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#exogenousModal">
                            <i class="fas fa-file-import"></i> Inserir Eventos (CIOPS)
                        </button>
                        <a href="/connections" class="btn btn-outline-dark btn-sm">
                            <i class="fas fa-project-diagram"></i> Grafo de Influência (Top 30)
                        </a>
                    </div>

                    <div class="d-grid gap-2 mb-3">
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary btn-sm" id="btn-simulate">
                                <i class="fas fa-motorcycle"></i> Equipe
                            </button>
                            <button class="btn btn-outline-danger btn-sm" id="btn-simulate-exo">
                                <i class="fas fa-radiation"></i> Conflito
                            </button>
                        </div>
                        <button class="btn btn-outline-secondary btn-sm d-none" id="btn-clear-sim">
                            <i class="fas fa-undo"></i> Limpar Simulação
                        </button>
                    </div>

                    <div id="selected-info">
                        <p class="text-muted">Clique em uma área no mapa para ver os motivos de risco aqui.</p>
                    </div>
                    <hr>
                    <div>
                        <div class="mb-2">
                            <label for="region-filter" class="form-label small fw-bold text-muted">Filtrar Região:</label>
                            <select class="form-select form-select-sm" id="region-filter">
                                <option value="all">Todas as Regiões</option>
                                <option value="capital">Capital (Fortaleza)</option>
                                <option value="rmf">Região Metropolitana (RMF)</option>
                                <option value="interior">Interior do Estado</option>
                            </select>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 fw-bold" id="top-list-title">Top 30 Áreas Críticas</h6>
                        </div>
                        <div id="top-areas" class="list-group list-group-flush small" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-12 text-center text-muted">
            <small>Sistema desenvolvido para apoio à decisão tática. Baseado em modelo ST-GCN.</small>
        </div>
    </div>
</div>

<!-- Modal CIOPS -->
<div class="modal fade" id="exogenousModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Inserir Eventos Exógenos (CIOPS)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted small">Cole os dados brutos de ocorrências (formato CIOPS) abaixo. O sistema identificará automaticamente as áreas e recalculará o risco.</p>
        <textarea class="form-control" id="ciops-text" rows="10" placeholder="Exemplo:&#10;01 - M20260051891 - RAIO 04 CAUCAIA - ... - CENTRO DE FORTALEZA ..."></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btn-process-ciops">Processar e Atualizar Mapa</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    var map = L.map('map').setView([-3.7319, -38.5267], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    // Global Map Click for Simulation (handling gaps between polygons)
    map.on('click', function(e) {
        if (simulationMode) {
            addSimulationPoint(e.latlng);
        }
    });

    function getColor(d) {
        return d > 80 ? '#800026' :
               d > 60  ? '#BD0026' :
               d > 40  ? '#E31A1C' :
               d > 20  ? '#FEB24C' :
               d > 10   ? '#FED976' :
                          '#90EE90';
    }

    function style(feature) {
        // Decide which score to use based on current mode
        var mode = $('#mode-switch').is(':checked') ? 'CVLI' : 'CVP';
        var score = (mode === 'CVLI') ? feature.properties.risk_score_cvli : feature.properties.risk_score_cvp;

        return {
            fillColor: getColor(score),
            weight: 2,
            opacity: 1,
            color: 'white',
            dashArray: '3',
            fillOpacity: 0.7
        };
    }

    function getStatus(score, type) {
        if (score > 80) return { label: 'CRÍTICO (' + type + ')', class: 'bg-danger' };
        if (score > 60) return { label: 'ALTO (' + type + ')', class: 'bg-warning text-dark' };
        if (score > 20) return { label: 'MÉDIO (' + type + ')', class: 'bg-info text-dark' };
        return { label: 'BAIXO (' + type + ')', class: 'bg-success' };
    }

    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'legend'),
            grades = [0, 10, 20, 40, 60, 80];
        div.innerHTML = '<strong>Nível de Risco</strong><br>';
        for (var i = 0; i < grades.length; i++) {
            div.innerHTML +=
                '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
        }
        return div;
    };
    legend.addTo(map);

    function formatDate(dateStr) {
        // Preserve explicit em-dash fallback
        if (!dateStr || dateStr === '—') return '—';

        // If already in dd/mm/yyyy, return as-is (quick heuristic)
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) return dateStr;

        // Try ISO-like date (YYYY-MM-DD or YYYY-MM-DDTHH:MM:SS)
        try {
            var iso = dateStr.trim();
            // Extract leading YYYY-MM-DD if present
            var m = iso.match(/(\d{4})-(\d{2})-(\d{2})/);
            if (m) {
                return m[3] + '/' + m[2] + '/' + m[1];
            }
            // Fallback: try Date parsing and format
            var d = new Date(dateStr);
            if (!isNaN(d.getTime())) {
                var dd = String(d.getDate()).padStart(2, '0');
                var mm = String(d.getMonth() + 1).padStart(2, '0');
                var yyyy = d.getFullYear();
                return dd + '/' + mm + '/' + yyyy;
            }
        } catch (e) {
            // ignore and fallthrough
        }
        return dateStr || '—';
    }

    var geojsonLayer = null;
    var riskDataGlobal = null;
    var metaDataGlobal = null;

    // Simulation State
    var simulationMode = false;
    var simulationType = 'suppression'; // 'suppression' or 'exogenous'
    var simulationPoints = [];
    var simMarkers = [];

    var motorIcon = L.divIcon({
        html: '<i class="fas fa-motorcycle fa-2x" style="color: blue; text-shadow: 2px 2px 4px white;"></i>',
        className: 'custom-div-icon',
        iconSize: [30, 30],
        iconAnchor: [15, 15]
    });

    var conflictIcon = L.divIcon({
        html: '<i class="fas fa-radiation fa-2x" style="color: red; text-shadow: 2px 2px 4px white;"></i>',
        className: 'custom-div-icon',
        iconSize: [30, 30],
        iconAnchor: [15, 15]
    });

    function showLoading(msg, sub) {
        $('#loading-message').text(msg || 'Processando Inteligência Tática...');
        $('#loading-sub').text(sub || 'Aguarde, analisando dados em tempo real.');
        $('#loading-overlay').removeClass('d-none');
    }

    function hideLoading() {
        $('#loading-overlay').addClass('d-none');
        // Hide overlay (keep element in DOM so it can be shown again)
        try {
            setTimeout(function() {
                if (map && map.invalidateSize) map.invalidateSize();
                $('#loading-overlay').addClass('d-none');
            }, 200);
        } catch(e) {
            console.warn('invalidateSize/hide overlay failed', e);
        }
    }

    function updateDashboard(mode) {
        var label = (mode === 'CVLI') ? 'Modo de Visualização: <strong>CVLI</strong>' : 'Modo de Visualização: <strong>CVP</strong>';
        $('#mode-label').html(label);

        // Update Window Info
        var startDate = (mode === 'CVLI') ? metaDataGlobal.start_cvli : metaDataGlobal.start_cvp;
        var endDate = metaDataGlobal.last_date;
        var days = (mode === 'CVLI') ? metaDataGlobal.window_cvli : metaDataGlobal.window_cvp;

        var dateText = formatDate(startDate) + ' → ' + formatDate(endDate);
        $('#window-info small.text-muted').text('Janela Histórica: ' + dateText + ' (' + days + ' dias)');

        var horizonText = (mode === 'CVLI') ? 'Horizonte de Predição: 14 dias (336h)' : 'Horizonte de Predição: 7 dias (168h)';
        $('#horizon-info').text(horizonText);

        // Recalculate Stats
        var highRisk = 0, mediumRisk = 0, lowRisk = 0;
        riskDataGlobal.forEach(function(item) {
            var score = (mode === 'CVLI') ? item.risk_score_cvli : item.risk_score_cvp;
            if (score > 60) highRisk++;
            else if (score > 20) mediumRisk++;
            else lowRisk++;
        });

        $('#high-risk-count').text(highRisk);
        $('#medium-risk-count').text(mediumRisk);
        $('#low-risk-count').text(lowRisk);

        // Update Map Style
        if (geojsonLayer) {
            geojsonLayer.eachLayer(function(layer) {
                layer.setStyle(style(layer.feature));
            });
        }
        updateTopCriticalAreas();
    }

    function addSimulationPoint(latlng) {
        var icon = (simulationType === 'suppression') ? motorIcon : conflictIcon;
        var marker = L.marker(latlng, {icon: icon}).addTo(map);
        simMarkers.push(marker);
        simulationPoints.push([latlng.lat, latlng.lng]);

        // Call API
        showLoading('Simulando Cenário...', 'Projetando impacto e risco na malha.');
        $.ajax({
            url: '/api/simulate',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ points: simulationPoints, type: simulationType }),
            success: function(resp) {
                if(resp.data) {
                    riskDataGlobal = resp.data;
                    updateRiskMap(riskDataGlobal);
                    var mode = $('#mode-switch').is(':checked') ? 'CVLI' : 'CVP';
                    updateDashboard(mode);
                }
            },
            error: function(err) {
                console.error("Simulation error", err);
                alert("Erro ao simular: " + err.statusText);
            },
            complete: function() {
                hideLoading();
            }
        });

        $('#btn-clear-sim').removeClass('d-none');
    }

    function clearSimulation() {
        simMarkers.forEach(function(m) { map.removeLayer(m); });
        simMarkers = [];
        simulationPoints = [];
        $('#btn-clear-sim').addClass('d-none');

        // Reload original data
        showLoading('Restaurando Estado Original...', 'Recuperando dados históricos.');
         $.getJSON('/api/risk', function(resp) {
            riskDataGlobal = resp.data || resp;
            updateRiskMap(riskDataGlobal);
            var mode = $('#mode-switch').is(':checked') ? 'CVLI' : 'CVP';
            updateDashboard(mode);
        }).always(function() {
            hideLoading();
        });
    }

    function updateRiskMap(riskData) {
        var riskMapCVLI = {};
        var riskMapCVP = {};

        riskData.forEach(function(item) {
            riskMapCVLI[item.node_id] = item.risk_score_cvli || 0;
            riskMapCVP[item.node_id] = item.risk_score_cvp || 0;
        });

        geojsonLayer.eachLayer(function(layer) {
            var index = layer.feature.properties.node_id; // Need to ensure node_id is available in properties.
            // Wait, previous code used array index matching.
            // "geojson.features.forEach(function(feature, index) {...}"
            // We need to map back.
            // The safest way is to assume array order is preserved.

            // Let's rely on the loop index if node_id is not set,
            // but we need the index. Leaflet layers don't expose index easily unless we stored it.
            // In initial load, we stored risk data into properties.
            // We should do the same here.

            // Wait, we can't easily iterate layers in order matching the array unless we assigned IDs.
            // Let's check initial load logic again.
        });

        // Re-process all features logic is complex inside leaflet loop.
        // Easier: Re-apply properties to the GeoJSON features source and redraw? No, slow.
        // Best: In initial load, assign an ID to each feature property if not exists.

        // But let's look at initial load again.
        // "geojson.features.forEach(function(feature, index) { ... }"
        // It updates `feature.properties`.
        // Leaflet layers reference `feature`. If we update `feature.properties`, does it update style?
        // `layer.feature` is a reference. So updating it works.

        // So we need to iterate geojson features again?
        // We don't have direct access to the original geojson object easily unless stored.
        // But `geojsonLayer.toGeoJSON()` returns new geojson.
        // `geojsonLayer.getLayers()` returns array of layers.

        // Let's assume `geojsonLayer` layers are consistent.
        var layers = geojsonLayer.getLayers();
        riskData.forEach(function(item, idx) {
            if (layers[idx]) {
                var layer = layers[idx];
                layer.feature.properties.risk_score_cvli = item.risk_score_cvli;
                layer.feature.properties.risk_score_cvp = item.risk_score_cvp;
                layer.feature.properties.cvli_pred = item.cvli_pred;
                layer.feature.properties.cvp_pred = item.cvp_pred;
                layer.feature.properties.reasons = item.reasons;
                // Update popup content if needed? Popups are bound on click, so they read current properties.
                // Except the `bindPopup` string is created at binding time.
                // We need to re-bind popup or use a function for content.
                // The current code binds a static string. I should change it to a function.
            }
        });
    }

    $.when(
        $.getJSON('/api/polygons'),
        $.getJSON('/api/risk')
    ).done(function(polygonsArgs, riskArgs) {
        var geojson = polygonsArgs[0];
        var riskResp = riskArgs[0];
        riskDataGlobal = riskResp.data || riskResp;
        metaDataGlobal = riskResp.meta || {};

        var riskMapCVLI = {};
        var riskMapCVP = {};

        riskDataGlobal.forEach(function(item) {
            riskMapCVLI[item.node_id] = item.risk_score_cvli || 0;
            riskMapCVP[item.node_id] = item.risk_score_cvp || 0;
        });

        geojson.features.forEach(function(feature, index) {
            var r = riskDataGlobal[index] || {};
            feature.properties.risk_score_cvli = riskMapCVLI[index] || 0;
            feature.properties.risk_score_cvp = riskMapCVP[index] || 0;
            feature.properties.cvli_pred = (r.cvli_pred !== undefined) ? r.cvli_pred : 0;
            feature.properties.cvp_pred = (r.cvp_pred !== undefined) ? r.cvp_pred : 0;
            feature.properties.faction = r.faction || feature.properties.faction || null;
            feature.properties.reasons = r.reasons || [];
            feature.properties.name = feature.properties.name || 'Área ' + index;
        });

        // Initialize Map
        geojsonLayer = L.geoJson(geojson, {
            style: style,
            onEachFeature: function(feature, layer) {
                // Click handler
                layer.on('click', function(e) {
                    if (simulationMode) {
                        L.DomEvent.stopPropagation(e); // Prevent map click from firing twice
                        addSimulationPoint(e.latlng);
                    } else {
                        showFeatureDetails(layer, e.latlng);
                        // Zoom to feature (Zoom In)
                        map.fitBounds(layer.getBounds(), { maxZoom: 16 });
                    }
                });
            }
        }).addTo(map);

        // Ensure Leaflet recalculates container size now that the geojson layer is added
        try {
            setTimeout(function() { if (map && map.invalidateSize) map.invalidateSize(); }, 200);
        } catch(e) {
            console.warn('invalidateSize after geojson failed', e);
        }

    // As a final fallback, ensure the overlay is removed and map resized on full window load
    $(window).on('load', function() {
        try {
            setTimeout(function() {
                if (map && map.invalidateSize) map.invalidateSize();
                $('#loading-overlay').addClass('d-none');
            }, 300);
        } catch(e) {
            console.warn('window.load invalidateSize failed', e);
        }
    });

        updateTopCriticalAreas();

        // Initial State
        updateDashboard('CVLI');

        // Double click to zoom out (Afastar)
        map.doubleClickZoom.disable();
        map.on('dblclick', function() {
           map.setView([-3.7319, -38.5267], 12);
        });

        // Toggle handler
        $('#mode-switch').on('change', function() {
            var isCvli = $(this).is(':checked');
            updateDashboard(isCvli ? 'CVLI' : 'CVP');
        });

        // Simulation handlers
        $('#btn-simulate').on('click', function() {
            if (simulationMode && simulationType === 'suppression') {
                // Toggle off
                simulationMode = false;
                $(this).removeClass('active btn-primary').addClass('btn-outline-primary');
                $('.leaflet-container').removeClass('simulation-active');
            } else {
                // Toggle on
                simulationMode = true;
                simulationType = 'suppression';
                $(this).addClass('active btn-primary').removeClass('btn-outline-primary');
                $('#btn-simulate-exo').removeClass('active btn-danger').addClass('btn-outline-danger');
                $('.leaflet-container').addClass('simulation-active');
            }
        });

        $('#btn-simulate-exo').on('click', function() {
            if (simulationMode && simulationType === 'exogenous') {
                // Toggle off
                simulationMode = false;
                $(this).removeClass('active btn-danger').addClass('btn-outline-danger');
                $('.leaflet-container').removeClass('simulation-active');
            } else {
                // Toggle on
                simulationMode = true;
                simulationType = 'exogenous';
                $(this).addClass('active btn-danger').removeClass('btn-outline-danger');
                $('#btn-simulate').removeClass('active btn-primary').addClass('btn-outline-primary');
                $('.leaflet-container').addClass('simulation-active');
            }
        });

        $('#btn-clear-sim').on('click', function() {
            clearSimulation();
        });

        // Exogenous Data Handler
        $('#btn-process-ciops').on('click', function() {
            var text = $('#ciops-text').val();
            if (!text.trim()) {
                alert('Por favor, insira os dados.');
                return;
            }

            // Hide Modal
            var modalEl = document.getElementById('exogenousModal');
            var modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            showLoading('Geolocalizando Eventos...', 'Identificando coordenadas e bairros.');

            $.ajax({
                url: '/api/exogenous/parse',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ text: text }),
                success: function(resp) {
                    if (resp.points && resp.points.length > 0) {

                        // Add markers visually but DO NOT implicitly toggle global simulationMode.
                        // This prevents the simulation buttons from being activated automatically
                        // when the malha is adapted, avoiding unexpected UX side-effects.
                        resp.points.forEach(function(pt) {
                            var latlng = [pt.lat, pt.lng];
                            var marker = L.marker(latlng, {icon: conflictIcon})
                                .bindPopup('<strong>Evento Exógeno</strong><br>' + pt.description)
                                .addTo(map);
                            simMarkers.push(marker);
                            simulationPoints.push(latlng);
                        });
                        // Show the clear control so the user can remove these visual markers if desired
                        $('#btn-clear-sim').removeClass('d-none');

        // SAVE changes permanently (as requested)
                        showLoading('Registrando e Adaptando Malha...', 'Salvando eventos e recalculando modelo global.');

                        $.ajax({
                            url: '/api/exogenous/save',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({
                                points: resp.points,
                                original_text: text
                            }),
                            success: function(saveResp) {
                                // Clear Form
                                $('#ciops-text').val('');

                                // Refresh Risk Data from Server (since server reloaded model)
                                $.getJSON('/api/risk', function(riskResp) {
                                     riskDataGlobal = riskResp.data || riskResp;
                                     updateRiskMap(riskDataGlobal);
                                     var mode = $('#mode-switch').is(':checked') ? 'CVLI' : 'CVP';
                                     updateDashboard(mode);

                                     hideLoading();
                                     alert('Eventos salvos com sucesso!\nA malha foi adaptada permanentemente e o risco recalculado.');

                                     // Ensure simulation mode is NOT left active after malha adaptation.
                                     simulationMode = false;
                                     simulationType = 'suppression';
                                     // Reset button visual states
                                     $('#btn-simulate').removeClass('active btn-primary').addClass('btn-outline-primary');
                                     $('#btn-simulate-exo').removeClass('active btn-danger').addClass('btn-outline-danger');
                                     $('.leaflet-container').removeClass('simulation-active');

                                     // Add markers visual feedback for this session (saved)
                                     resp.points.forEach(function(pt) {
                                        L.marker([pt.lat, pt.lng], {icon: conflictIcon})
                                            .bindPopup('<strong>Evento Exógeno (Salvo)</strong><br>' + pt.description)
                                            .addTo(map);
                                     });
                                });
                            },
                            error: function(err) {
                                hideLoading();
                                console.error("Save error", err);
                                alert("Erro ao salvar eventos: " + err.statusText);
                            }
                        });

                    } else {
                        hideLoading();
                        alert('Nenhuma localização válida identificada nos dados fornecidos.');
                    }
                },
                error: function(err) {
                    hideLoading();
                    console.error("Parsing error", err);
                    alert("Erro ao processar dados: " + err.statusText);
                }
            });
        });
    }).always(function() {
        hideLoading();
    });

    // RMF Cities Definition (Excluding Fortaleza)
    var rmfCities = [
        "Aquiraz", "Cascavel", "Caucaia", "Chorozinho", "Eusébio",
        "Guaiúba", "Horizonte", "Itaitinga", "Maracanaú", "Maranguape",
        "Pacajus", "Pacatuba", "Paracuru", "Paraipaba", "Pindoretama",
        "São Gonçalo do Amarante", "São Luís do Curu", "Trairi"
    ];

    function getRegionType(cidade) {
        if (!cidade) return 'unknown';
        var c = cidade.trim();
        if (c === 'Fortaleza') return 'capital';
        if (rmfCities.includes(c)) return 'rmf';
        if (c === 'RMF/Interior') return 'unknown'; // Fallback
        return 'interior';
    }

    function getRiskLevel(score) {
        if (score > 80) return { label: 'Crítico', class: 'text-danger' };
        if (score > 60) return { label: 'Alto', class: 'text-warning' };
        if (score > 20) return { label: 'Médio', class: 'text-info' };
        return { label: 'Normal', class: 'text-success' };
    }

    function showFeatureDetails(layer, latlng) {
        var feature = layer.feature;
        var mode = $('#mode-switch').is(':checked') ? 'CVLI' : 'CVP';
        var score = (mode === 'CVLI') ? feature.properties.risk_score_cvli : feature.properties.risk_score_cvp;
        var predVal = (mode === 'CVLI') ? feature.properties.cvli_pred : feature.properties.cvp_pred;
        var typeLabel = (mode === 'CVLI') ? 'CVLI' : 'CVP';
        var status = getStatus(score, typeLabel);
        var region = feature.properties.CIDADE || 'RMF/Interior';

        // Friendly fields provided by backend: status_label, risk_text, cvli_prediction_text, cvp_prediction_text
        var friendlyLabel = feature.properties.status_label || status.label;
        var level = getRiskLevel(score);
        var riskText = feature.properties.risk_text || (Math.round(score) + '% — ' + friendlyLabel);
        var predText = (mode === 'CVLI') ? (feature.properties.cvli_prediction_text || (predVal && predVal > 0 ? ('Estimativa: ~' + predVal.toFixed(1) + ' ocorrências') : 'Sem novas ocorrências previstas')) : (feature.properties.cvp_prediction_text || (predVal && predVal > 0 ? ('Estimativa: ~' + predVal.toFixed(1) + ' ocorrências') : 'Sem novas ocorrências previstas'));

        var popupContent = `
            <div style="font-family: sans-serif; font-size: 14px; min-width: 200px;">
                <h6 class="mb-1"><strong>Bairro/Área:</strong> ${feature.properties.name}</h6>
                <div class="text-muted small mb-2">
                    <strong>Região:</strong> ${region}<br>
                    <strong>Facção:</strong> ${feature.properties.faction || 'Não Identificado'}
                </div>
                <hr class="my-2">
                <div class="mb-2">
                    <strong>Status:</strong> <span class="badge ${level.class}">${friendlyLabel}</span>
                </div>
                <div class="mb-1">
                    <strong>Risco:</strong> ${riskText}
                </div>
                <div class="text-muted small">
                    <strong>Previsão (${typeLabel}):</strong> ${predText}
                </div>
                <div class="text-muted small mt-2">
                    <em id="model-note-${feature.properties.node_id}"></em>
                </div>
            </div>
        `;

        // Inject model-note based on global meta if available
        try {
            var modelWindow = metaDataGlobal && metaDataGlobal.model_window_cvli ? metaDataGlobal.model_window_cvli : null;
            if (modelWindow) {
                var note = `Modelo atualizado — previsões baseadas em janela de ${modelWindow} dias`;
                // element with dynamic id will exist in popup DOM once opened; use setTimeout to set it
                setTimeout(function() {
                    var el = document.getElementById('model-note-' + feature.properties.node_id);
                    if (el) el.textContent = note;
                }, 10);
            }
        } catch (e) {
            // ignore
        }

        // Create popup and open it manually
        L.popup()
            .setLatLng(latlng)
            .setContent(popupContent)
            .openOn(map);

        // Sidebar update
        var reasonsHtml = '<h5>' + feature.properties.name + '</h5>';
        reasonsHtml += '<p><strong>Facção:</strong> ' + (feature.properties.faction || 'N/A') + '</p>';
        var sideStatus = feature.properties.status_label || status.label;
        var sidePred = (mode === 'CVLI') ? (feature.properties.cvli_prediction_text || (predVal && predVal > 0 ? ('~' + predVal.toFixed(1) + ' ocorrências') : 'Sem novas ocorrências previstas')) : (feature.properties.cvp_prediction_text || (predVal && predVal > 0 ? ('~' + predVal.toFixed(1) + ' ocorrências') : 'Sem novas ocorrências previstas'));
        reasonsHtml += '<p><strong>Status:</strong> ' + sideStatus + '</p>';
        reasonsHtml += '<p><strong>Previsão (' + typeLabel + '):</strong> ' + sidePred + '</p>';
        reasonsHtml += '<h6>Motivos</h6><ul>';
        (feature.properties.reasons || []).forEach(function(r) { reasonsHtml += '<li>' + r + '</li>'; });
        reasonsHtml += '</ul>';
        $('#selected-info').html(reasonsHtml);
    }

    function updateTopCriticalAreas() {
        // Use geojsonLayer layers to access up-to-date properties
        var layers = geojsonLayer.getLayers();
        var mode = $('#mode-switch').is(':checked') ? 'CVLI' : 'CVP';
        var regionFilter = $('#region-filter').val();

        // Map to array for sorting
        var items = [];
        layers.forEach(function(layer) {
            var props = layer.feature.properties;
            var score = (mode === 'CVLI') ? (props.risk_score_cvli || 0) : (props.risk_score_cvp || 0);

            // Filter Logic
            var regionType = getRegionType(props.CIDADE);
            var include = false;

            if (regionFilter === 'all') include = true;
            else if (regionFilter === 'capital' && regionType === 'capital') include = true;
            else if (regionFilter === 'rmf' && regionType === 'rmf') include = true;
            else if (regionFilter === 'interior' && regionType === 'interior') include = true;

            if (include) {
                items.push({
                    name: props.name,
                    score: score,
                    layer: layer,
                    cidade: props.CIDADE
                });
            }
        });

        // Sort descending
        items.sort(function(a, b) { return b.score - a.score; });

        // Update Title Count
        var countText = items.length > 30 ? 'Top 30' : 'Total ' + items.length;
        $('#top-list-title').text(countText + ' Áreas Críticas');

        // Take top 30
        var top30 = items.slice(0, 30);

        var html = '';
        if (top30.length === 0) {
            html = '<div class="text-muted text-center py-3">Nenhuma área encontrada nesta região.</div>';
        }

        top30.forEach(function(item, idx) {
            var riskInfo = getRiskLevel(item.score);

            // Region Display logic (Show city if not Fortaleza)
            var regionSuffix = '';
            if (item.cidade && item.cidade !== 'Fortaleza' && item.cidade !== 'RMF/Interior') {
                regionSuffix = ' - <small class="text-muted">' + item.cidade + '</small>';
            }

            // Create a clickable item
            html += `<a href="#" class="list-group-item list-group-item-action py-2 ps-2 pe-1" data-idx="${idx}">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <span class="mb-1">
                                ${idx+1}. ${item.name}${regionSuffix}
                            </span>
                            <div class="text-end ms-2" style="min-width: 70px;">
                                <small class="d-block text-muted" style="font-size: 0.7rem; line-height: 1;">Risco</small>
                                <span class="${riskInfo.class} fw-bold" style="font-size: 0.85rem;">${riskInfo.label}</span>
                            </div>
                        </div>
                    </a>`;
        });

        $('#top-areas').html(html);

        // Bind clicks
        $('#top-areas a').on('click', function(e) {
            e.preventDefault();
            var idx = $(this).data('idx');
            var item = top30[idx];
            if (item && item.layer) {
                map.flyTo(item.layer.getBounds().getCenter(), 15);
                showFeatureDetails(item.layer, item.layer.getBounds().getCenter());
            }
        });
    }

    // Filter Handler
    $('#region-filter').on('change', function() {
        updateTopCriticalAreas();
    });
</script>
</body>
</html>
