<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento de Inteligência - Segurança Pública</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { padding-top: 20px; background-color: #f8f9fa; }
        #map { height: 650px; width: 100%; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .metric-card { transition: transform 0.2s; }
        .metric-card:hover { transform: translateY(-5px); }
        .legend { background: white; padding: 10px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7; }
        .control-panel { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="display-6 fw-bold text-primary"><i class="fas fa-shield-alt"></i> Dashboard de Inteligência Preditiva</h1>
            <p class="lead text-muted">Análise de Risco em Áreas Monitoradas (CVLI & CVP)</p>
        </div>
    </div>

    <!-- Painel de Controle e Filtros -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="control-panel">
                <div class="row align-items-end g-3">
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Tipo de Crime:</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="crime-type" id="btn-cvli" autocomplete="off" checked>
                            <label class="btn btn-outline-danger" for="btn-cvli">CVLI (Letalidade)</label>

                            <input type="radio" class="btn-check" name="crime-type" id="btn-cvp" autocomplete="off">
                            <label class="btn btn-outline-warning" for="btn-cvp">CVP (Patrimônio)</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Região:</label>
                        <select class="form-select" id="region-filter">
                            <option value="Todos">Todas as Regiões</option>
                            <option value="Fortaleza">Fortaleza</option>
                            <option value="RMF">Região Metropolitana</option>
                            <option value="Interior">Interior</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Data da Análise:</label>
                        <input type="date" class="form-control" id="date-filter">
                        <small class="text-muted">Padrão: Hoje (Predição Futura)</small>
                    </div>
                    <div class="col-md-3 text-end">
                        <button class="btn btn-outline-primary me-2 mb-2" data-bs-toggle="modal" data-bs-target="#exogenousModal">
                            <i class="fas fa-database"></i> Eventos Exógenos
                        </button>
                        <button class="btn btn-outline-dark mb-2" id="btn-simulation-mode">
                            <i class="fas fa-motorcycle"></i> Simular Equipe
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards de Métricas -->
    <div class="row mb-4 justify-content-center">
        <div class="col-md-3">
            <div class="card metric-card border-danger mb-3">
                <div class="card-body text-center">
                    <h5 class="card-title text-danger">Áreas Críticas (Top 10%)</h5>
                    <p class="card-text display-4 fw-bold" id="critical-count">-</p>
                    <small class="text-muted" id="metric-subtitle">CVLI (Próx 30 dias)</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card border-success mb-3">
                <div class="card-body text-center">
                    <h5 class="card-title text-success">Áreas Normais</h5>
                    <p class="card-text display-4 fw-bold" id="normal-count">-</p>
                    <small class="text-muted">Monitoramento Padrão</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Mapa -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white text-dark d-flex justify-content-between align-items-center">
                    <span class="fw-bold"><i class="fas fa-map-marked-alt"></i> Mapa Tático Operacional - Zonas de Calor</span>
                    <span id="simulation-status" class="badge bg-warning text-dark d-none">Modo Simulação Ativo: Clique no mapa</span>
                </div>
                <div class="card-body p-0">
                    <div id="map"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Dados Exógenos -->
<div class="modal fade" id="exogenousModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Inserção de Dados Exógenos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="exogenousForm">
                    <div class="mb-3">
                        <label class="form-label">Tipo de Evento</label>
                        <select class="form-select" name="type" required>
                            <option value="Morte de Liderança">Morte de Liderança</option>
                            <option value="Disputa de Território">Disputa de Território</option>
                            <option value="Aumento CVP">Aumento CVP</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Detalhes do Evento</label>
                        <textarea class="form-control" name="details" rows="4" placeholder="Descreva o evento detalhadamente..." required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Data do Evento</label>
                        <input type="date" class="form-control" name="date" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Criminosos Envolvidos (Nome, Facção, Endereço, etc)</label>
                        <textarea class="form-control" name="criminals" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Salvar Evento</button>
                </form>
                <hr>
                <h6>Eventos Registrados</h6>
                <div id="exogenousList" class="list-group"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    var map = L.map('map').setView([-3.7319, -38.5267], 10); // Zoom out a bit to see RMF/Interior

    // Light/Positron Map for "Harmonic and Modern" look
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    var currentLayer = null;
    var simulationMode = false;
    var currentSimulationParams = null;
    var simulationMarker = null;

    // Set today's date as default
    document.getElementById('date-filter').valueAsDate = new Date();

    function getColor(value, isCritical) {
        // Modern Harmonic Palette
        // Critical: Vibrant Orange/Red
        if (isCritical) return '#f83600';
        
        // Gradient: Light Blue -> Soft Yellow -> Soft Pink/Red
        return value > 80 ? '#fa709a' : // Soft Red
               value > 60 ? '#fee140' : // Soft Yellow
               value > 40 ? '#96e6a1' : // Soft Green
               value > 20 ? '#84fab0' : // Light Green/Blue
                            '#4facfe'; // Light Blue (Low Risk)
    }

    function loadData(simulationParams = null) {
        var type = $('#btn-cvli').is(':checked') ? 'cvli' : 'cvp';
        var region = $('#region-filter').val();
        var date = $('#date-filter').val();
        
        var url = '/api/risk?crime=' + type + '&region=' + region + '&date=' + date;
        if (simulationParams) {
            url += '&simulation=' + simulationParams;
        }

        $.when(
            $.getJSON('/api/polygons'),
            $.getJSON(url)
        ).done(function(polygonsArgs, riskArgs) {
            var geojson = polygonsArgs[0];
            var riskData = riskArgs[0];
            var riskMap = {};

            var criticalCount = 0;
            var normalCount = 0;

            // Create a set of valid node IDs based on the response (which is filtered)
            var validNodeIds = new Set();

            riskData.forEach(function(item) {
                var d = item[type];
                riskMap[item.node_id] = item; // Store full item
                validNodeIds.add(item.node_id);

                if (d.is_critical) criticalCount++;
                else normalCount++;
            });

            $('#critical-count').text(criticalCount);
            $('#normal-count').text(normalCount);

            if (type === 'cvli') {
                $('#metric-subtitle').text('CVLI (Próx 30 dias)');
            } else {
                $('#metric-subtitle').text('CVP (Próx 7 dias)');
            }

            if (currentLayer) map.removeLayer(currentLayer);

            // Filter GeoJSON based on validNodeIds (Region Filter)
            var filteredFeatures = geojson.features.filter(function(f) {
                return validNodeIds.has(f.properties.node_id);
            });

            var filteredGeojson = {
                type: "FeatureCollection",
                features: filteredFeatures
            };

            currentLayer = L.geoJson(filteredGeojson, {
                style: function(feature) {
                    var item = riskMap[feature.properties.node_id];
                    var d = item[type];
                    var val = d ? d.normalized : 0;
                    var isCritical = d ? d.is_critical : false;
                    return {
                        fillColor: getColor(val, isCritical),
                        weight: 0, // No border for cleaner look
                        opacity: 0,
                        color: 'white',
                        dashArray: '',
                        fillOpacity: 0.6 // Glassy effect
                    };
                },
                onEachFeature: function(feature, layer) {
                    var item = riskMap[feature.properties.node_id];
                    if (item) {
                        var d = item[type];
                        var statusLabel = d.is_critical ?
                            `<span class="badge bg-danger">CRÍTICO (${type.toUpperCase()})</span>` :
                            `<span class="badge bg-success">Normal</span>`;

                        var content = `<strong>Bairro/Área:</strong> ${feature.properties.node_id}<br>
                                       <strong>Região:</strong> ${item.region}<br>
                                       <strong>Facção:</strong> ${item.faction}<br>
                                       <hr>
                                       <strong>Status:</strong> ${statusLabel}<br>
                                       <strong>Risco (${type.toUpperCase()}):</strong> ${d.value.toFixed(2)}<br>
                                       <small>Normalizado: ${d.normalized.toFixed(0)}%</small>`;
                        layer.bindPopup(content);
                    }
                }
            }).addTo(map);

            // Adjust bounds if features exist
            if(filteredFeatures.length > 0) {
                map.fitBounds(currentLayer.getBounds());
            }
        });
    }

    // Event Listeners
    $('input[name="crime-type"]').change(function() {
        loadData(currentSimulationParams);
    });

    $('#region-filter').change(function() {
        loadData(currentSimulationParams);
    });

    $('#date-filter').change(function() {
        loadData(currentSimulationParams);
    });

    $('#btn-simulation-mode').click(function() {
        simulationMode = !simulationMode;
        if (simulationMode) {
            $(this).addClass('active btn-primary').removeClass('btn-outline-dark');
            $('#simulation-status').removeClass('d-none');
            map.getContainer().style.cursor = 'crosshair';
        } else {
            $(this).removeClass('active btn-primary').addClass('btn-outline-dark');
            $('#simulation-status').addClass('d-none');
            map.getContainer().style.cursor = '';
            currentSimulationParams = null;
            if (simulationMarker) map.removeLayer(simulationMarker);
            loadData();
        }
    });

    map.on('click', function(e) {
        if (simulationMode) {
            var lat = e.latlng.lat;
            var lon = e.latlng.lng;

            if (simulationMarker) map.removeLayer(simulationMarker);
            simulationMarker = L.marker([lat, lon], {
                icon: L.divIcon({
                    className: 'fa fa-motorcycle fa-2x text-primary',
                    iconSize: [30, 30]
                })
            }).addTo(map);

            currentSimulationParams = `${lat},${lon}`;
            loadData(currentSimulationParams);
        }
    });

    // Initial Load
    loadData();

    // Exogenous Data Form
    $('#exogenousForm').submit(function(e) {
        e.preventDefault();
        var formData = {
            type: $('select[name="type"]').val(),
            details: $('textarea[name="details"]').val(),
            date: $('input[name="date"]').val(),
            criminals: $('textarea[name="criminals"]').val()
        };

        $.ajax({
            url: '/api/exogenous',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                alert(response.message);
                $('#exogenousForm')[0].reset();
                loadExogenousList();
            }
        });
    });

    function loadExogenousList() {
        $.getJSON('/api/exogenous', function(data) {
            var list = $('#exogenousList');
            list.empty();
            data.forEach(function(item) {
                list.append(`
                    <a href="#" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${item.type}</h6>
                            <small>${item.date}</small>
                        </div>
                        <p class="mb-1">${item.details}</p>
                        <small class="text-muted">Envolvidos: ${item.criminals}</small>
                    </a>
                `);
            });
        });
    }

    $('#exogenousModal').on('show.bs.modal', loadExogenousList);
</script>
</body>
</html>
