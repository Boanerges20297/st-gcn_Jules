<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento de Inteligência - Segurança Pública</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { padding-top: 20px; background-color: #f8f9fa; }
        #map { height: 600px; width: 100%; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .metric-card { transition: transform 0.2s; }
        .metric-card:hover { transform: translateY(-5px); }
        .legend { background: white; padding: 10px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7; }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="display-6 fw-bold text-primary"><i class="fas fa-shield-alt"></i> Dashboard de Inteligência Preditiva</h1>
            <p class="lead text-muted">Análise de Risco em Áreas Monitoradas (CVLI & CVP)</p>
        </div>
    </div>
    <div class="row mb-4 justify-content-center">
        <div class="col-md-3">
            <div class="card metric-card border-danger mb-3">
                <div class="card-body text-center">
                    <h5 class="card-title text-danger">Áreas de Alto Risco</h5>
                    <p class="card-text display-4 fw-bold" id="high-risk-count">-</p>
                    <small class="text-muted">Previsão para Amanhã</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card border-warning mb-3">
                <div class="card-body text-center">
                    <h5 class="card-title text-warning">Áreas em Alerta</h5>
                    <p class="card-text display-4 fw-bold" id="medium-risk-count">-</p>
                    <small class="text-muted">Atenção Necessária</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card border-success mb-3">
                <div class="card-body text-center">
                    <h5 class="card-title text-success">Áreas Estáveis</h5>
                    <p class="card-text display-4 fw-bold" id="low-risk-count">-</p>
                    <small class="text-muted">Monitoramento Padrão</small>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-9">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-map-marked-alt"></i> Mapa Tático Operacional</span>
                    <span class="badge bg-danger">Dados Atualizados: Hoje</span>
                </div>
                <div class="card-body p-0">
                    <div id="map"></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-header">
                    <strong>Motivos de Risco</strong>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="mode-switch" checked>
                        <label class="form-check-label" for="mode-switch" id="mode-label">Modo de Visualização: <strong>CVLI</strong></label>
                    </div>
                    <div id="window-info" class="mb-2">
                        <small class="text-muted d-block">Janela Histórica: —</small>
                        <small class="text-primary fw-bold" id="horizon-info">Horizonte: —</small>
                    </div>
                    <div id="selected-info">
                        <p class="text-muted">Clique em uma área no mapa para ver os motivos de risco aqui.</p>
                    </div>
                    <hr>
                    <div>
                        <h6>Top motivos gerais</h6>
                        <ul id="top-reasons" class="small"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-12 text-center text-muted">
            <small>Sistema desenvolvido para apoio à decisão tática. Baseado em modelo ST-GCN.</small>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    var map = L.map('map').setView([-3.7319, -38.5267], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    function getColor(d) {
        return d > 80 ? '#800026' :
               d > 60  ? '#BD0026' :
               d > 40  ? '#E31A1C' :
               d > 20  ? '#FEB24C' :
               d > 10   ? '#FED976' :
                          '#90EE90';
    }

    function style(feature) {
        // Decide which score to use based on current mode
        var mode = $('#mode-switch').is(':checked') ? 'CVLI' : 'CVP';
        var score = (mode === 'CVLI') ? feature.properties.risk_score_cvli : feature.properties.risk_score_cvp;

        return {
            fillColor: getColor(score),
            weight: 2,
            opacity: 1,
            color: 'white',
            dashArray: '3',
            fillOpacity: 0.7
        };
    }

    function getStatus(score, type) {
        if (score > 80) return { label: 'CRÍTICO (' + type + ')', class: 'bg-danger' };
        if (score > 60) return { label: 'ALTO (' + type + ')', class: 'bg-warning text-dark' };
        if (score > 20) return { label: 'MÉDIO (' + type + ')', class: 'bg-info text-dark' };
        return { label: 'BAIXO (' + type + ')', class: 'bg-success' };
    }

    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'legend'),
            grades = [0, 10, 20, 40, 60, 80];
        div.innerHTML = '<strong>Nível de Risco</strong><br>';
        for (var i = 0; i < grades.length; i++) {
            div.innerHTML +=
                '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
        }
        return div;
    };
    legend.addTo(map);

    function formatDate(dateStr) {
        if (!dateStr) return '?';
        var parts = dateStr.split('-');
        if (parts.length === 3) {
            return parts[2] + '/' + parts[1] + '/' + parts[0];
        }
        return dateStr;
    }

    var geojsonLayer = null;
    var riskDataGlobal = null;
    var metaDataGlobal = null;

    function updateDashboard(mode) {
        var label = (mode === 'CVLI') ? 'Modo de Visualização: <strong>CVLI</strong>' : 'Modo de Visualização: <strong>CVP</strong>';
        $('#mode-label').html(label);

        // Update Window Info
        var startDate = (mode === 'CVLI') ? metaDataGlobal.start_cvli : metaDataGlobal.start_cvp;
        var endDate = metaDataGlobal.last_date;
        var days = (mode === 'CVLI') ? metaDataGlobal.window_cvli : metaDataGlobal.window_cvp;

        var dateText = formatDate(startDate) + ' → ' + formatDate(endDate);
        $('#window-info small.text-muted').text('Janela Histórica: ' + dateText + ' (' + days + ' dias)');

        var horizonText = (mode === 'CVLI') ? 'Horizonte de Predição: 3 dias (72h)' : 'Horizonte de Predição: 1 dia (24h)';
        $('#horizon-info').text(horizonText);

        // Recalculate Stats
        var highRisk = 0, mediumRisk = 0, lowRisk = 0;
        riskDataGlobal.forEach(function(item) {
            var score = (mode === 'CVLI') ? item.risk_score_cvli : item.risk_score_cvp;
            if (score > 60) highRisk++;
            else if (score > 20) mediumRisk++;
            else lowRisk++;
        });

        $('#high-risk-count').text(highRisk);
        $('#medium-risk-count').text(mediumRisk);
        $('#low-risk-count').text(lowRisk);

        // Update Map Style
        if (geojsonLayer) {
            geojsonLayer.eachLayer(function(layer) {
                layer.setStyle(style(layer.feature));
            });
        }
    }

    $.when(
        $.getJSON('/api/polygons'),
        $.getJSON('/api/risk')
    ).done(function(polygonsArgs, riskArgs) {
        var geojson = polygonsArgs[0];
        var riskResp = riskArgs[0];
        riskDataGlobal = riskResp.data || riskResp;
        metaDataGlobal = riskResp.meta || {};

        var riskMapCVLI = {};
        var riskMapCVP = {};

        riskDataGlobal.forEach(function(item) {
            riskMapCVLI[item.node_id] = item.risk_score_cvli || 0;
            riskMapCVP[item.node_id] = item.risk_score_cvp || 0;
        });

        geojson.features.forEach(function(feature, index) {
            var r = riskDataGlobal[index] || {};
            feature.properties.risk_score_cvli = riskMapCVLI[index] || 0;
            feature.properties.risk_score_cvp = riskMapCVP[index] || 0;
            feature.properties.cvli_pred = (r.cvli_pred !== undefined) ? r.cvli_pred : 0;
            feature.properties.cvp_pred = (r.cvp_pred !== undefined) ? r.cvp_pred : 0;
            feature.properties.faction = r.faction || feature.properties.faction || null;
            feature.properties.reasons = r.reasons || [];
            feature.properties.name = feature.properties.name || 'Área ' + index;
        });

        // Initialize Map
        geojsonLayer = L.geoJson(geojson, {
            style: style,
            onEachFeature: function(feature, layer) {
                // Pre-bind popup content
                layer.on('click', function() {
                     // Determine Mode
                    var mode = $('#mode-switch').is(':checked') ? 'CVLI' : 'CVP';
                    var score = (mode === 'CVLI') ? feature.properties.risk_score_cvli : feature.properties.risk_score_cvp;
                    var predVal = (mode === 'CVLI') ? feature.properties.cvli_pred : feature.properties.cvp_pred;
                    var typeLabel = (mode === 'CVLI') ? 'CVLI' : 'CVP';
                    var status = getStatus(score, typeLabel);
                    var region = feature.properties.CIDADE || 'RMF/Interior';

                    var popupContent = `
                        <div style="font-family: sans-serif; font-size: 14px; min-width: 200px;">
                            <h6 class="mb-1"><strong>Bairro/Área:</strong> ${feature.properties.name}</h6>
                            <div class="text-muted small mb-2">
                                <strong>Região:</strong> ${region}<br>
                                <strong>Facção:</strong> ${feature.properties.faction || 'Não Identificado'}
                            </div>
                            <hr class="my-2">
                            <div class="mb-2">
                                <strong>Status:</strong> <span class="badge ${status.class}">${status.label}</span>
                            </div>
                            <div class="mb-1">
                                <strong>Risco Normalizado:</strong> ${score.toFixed(1)}%
                            </div>
                            <div class="text-muted small">
                                <strong>Predição (${typeLabel}):</strong> ${predVal.toFixed(4)}
                            </div>
                        </div>
                    `;

                    layer.bindPopup(popupContent).openPopup();

                    // Sidebar update
                    var reasonsHtml = '<h5>' + feature.properties.name + '</h5>';
                    reasonsHtml += '<p><strong>Facção:</strong> ' + (feature.properties.faction || 'N/A') + '</p>';
                    reasonsHtml += '<p><strong>Risco (' + typeLabel + '):</strong> ' + score.toFixed(1) + '%</p>';
                    reasonsHtml += '<h6>Motivos</h6><ul>';
                    feature.properties.reasons.forEach(function(r) { reasonsHtml += '<li>' + r + '</li>'; });
                    reasonsHtml += '</ul>';
                    $('#selected-info').html(reasonsHtml);
                });
            }
        }).addTo(map);

        updateTopReasons(geojson.features);

        // Initial State
        updateDashboard('CVLI');

        // Toggle handler
        $('#mode-switch').on('change', function() {
            var isCvli = $(this).is(':checked');
            updateDashboard(isCvli ? 'CVLI' : 'CVP');
        });
    });

    function updateTopReasons(features) {
        var counter = {};
        features.forEach(function(f) {
            (f.properties.reasons || []).forEach(function(r) { counter[r] = (counter[r] || 0) + 1; });
        });
        var items = Object.keys(counter).sort(function(a,b){return counter[b]-counter[a];}).slice(0,10);
        var html = '';
        items.forEach(function(k){ html += '<li>' + k + ' <span class="text-muted">(' + counter[k] + ')</span></li>'; });
        $('#top-reasons').html(html);
    }
</script>
</body>
</html>
